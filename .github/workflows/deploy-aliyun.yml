name: Deploy to Aliyun

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-aliyun-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: aliyun-light
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.ALIYUN_HOST }}
          username: ${{ vars.ALIYUN_USER }}
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          port: ${{ vars.ALIYUN_PORT }}
          script: |
            set -e
            BASE_DIR="/home/admin/ci"
            REPO_NAME="${{ github.event.repository.name }}"
            PROJECT_DIR="${BASE_DIR}/${REPO_NAME}"
            REPO_URL="git@github.com:${{ github.repository }}.git"
            BRANCH="${{ github.ref_name }}"
            cd "$BASE_DIR"
            if [ ! -d "$PROJECT_DIR/.git" ]; then
              git clone --branch "$BRANCH" "$REPO_URL" "$PROJECT_DIR"
            else
              cd "$PROJECT_DIR"
              git pull --rebase origin "$BRANCH"
            fi
            cd "$PROJECT_DIR"
            npm ci
            bash restart.sh

            # 更新 nginx（仅配置变化时）
            NGINX_SRC="$PROJECT_DIR/ci/bazifenxi-nginx.conf"
            NGINX_DEST="/etc/nginx/conf.d/bazifenxi-nginx.conf"
            if [ ! -f "$NGINX_DEST" ] || ! cmp -s "$NGINX_SRC" "$NGINX_DEST"; then
              sudo cp "$NGINX_SRC" "$NGINX_DEST"
              sudo nginx -t
              sudo systemctl reload nginx
            fi
